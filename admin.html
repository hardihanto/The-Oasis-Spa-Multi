<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - SaaSBOOK</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <div id="loginArea" class="flex items-center justify-center min-h-screen p-6">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md border">
            <h2 class="text-2xl font-black text-center mb-6">Login Dashboard</h2>
            <div class="space-y-4">
                <input type="text" id="user" placeholder="ID Bisnis" class="w-full p-4 rounded-2xl border outline-none focus:ring-4 focus:ring-emerald-500/10">
                <input type="password" id="pass" placeholder="Password" class="w-full p-4 rounded-2xl border outline-none focus:ring-4 focus:ring-emerald-500/10">
                <button onclick="prosesLogin()" id="btnLog" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-emerald-600 shadow-xl transition">Masuk</button>
            </div>
            <div id="pendingMsg" class="hidden mt-6 p-4 bg-amber-50 border border-amber-100 rounded-2xl text-amber-700 text-sm text-center">
                ⚠️ <b>Akun Belum Aktif</b><br>Lisensi Anda sedang dalam tahap pending. Silakan lakukan pembayaran lisensi Rp 500.000/thn.
            </div>
        </div>
    </div>

    <div id="dashArea" class="hidden animate-in fade-in duration-700">
        <nav class="p-6 bg-white border-b flex justify-between items-center">
            <h1 id="txtNamaToko" class="font-black text-xl italic text-emerald-600">--</h1>
            <button onclick="logout()" class="text-rose-500 font-bold text-sm">Keluar</button>
        </nav>
        <main class="max-w-7xl mx-auto p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                <div class="bg-white p-8 rounded-[2rem] shadow-sm border">
                    <p class="text-xs font-bold text-slate-400 uppercase">Total Booking</p>
                    <h3 id="statTotal" class="text-4xl font-black mt-2">0</h3>
                </div>
                <div class="bg-emerald-500 p-8 rounded-[2rem] shadow-lg text-white">
                    <p class="text-xs font-bold opacity-80 uppercase">Hari Ini</p>
                    <h3 id="statToday" class="text-4xl font-black mt-2">0</h3>
                </div>
            </div>
            <div class="bg-white rounded-[2rem] border overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b">
                        <tr class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                            <th class="p-6">Pelanggan</th>
                            <th class="p-6">Tanggal & Jam</th>
                            <th class="p-6 text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="isiTabel" class="divide-y"></tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        const SB_URL = "https://strylleubkvuirsknqbk.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0cnlsbGV1Ymt2dWlyc2tucWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODM2OTksImV4cCI6MjA4NzA1OTY5OX0.sfnSvVgUoBRgwDyYY5VBAaHPHM_rPKBQ4a3w1ziKgUw";
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let activeId = localStorage.getItem('active_biz_id');

        window.onload = async () => {
            if(activeId) {
                const { data } = await sb.from('businesses').select('*').eq('id', activeId).single();
                if(data && data.is_active) showDashboard(data);
                else showLogin();
            } else { showLogin(); }
        };

        function showLogin() { document.getElementById('loginArea').classList.remove('hidden'); }

        async function prosesLogin() {
            const u = document.getElementById('user').value.toLowerCase();
            const p = document.getElementById('pass').value;
            const { data } = await sb.from('businesses').select('*').eq('id', u).eq('admin_password', p).maybeSingle();

            if (data) {
                if (!data.is_active) {
                    document.getElementById('pendingMsg').classList.remove('hidden');
                    return;
                }
                localStorage.setItem('active_biz_id', data.id);
                showDashboard(data);
            } else { alert("Login Salah!"); }
        }

        function showDashboard(data) {
            document.getElementById('loginArea').classList.add('hidden');
            document.getElementById('dashArea').classList.remove('hidden');
            document.getElementById('txtNamaToko').innerText = data.business_name;
            ambilData();
        }

        async function ambilData() {
            const { data } = await sb.from('bookings').select('*').eq('business_id', localStorage.getItem('active_biz_id')).order('created_at', {ascending: false});
            const tabel = document.getElementById('isiTabel');
            tabel.innerHTML = "";
            document.getElementById('statTotal').innerText = data.length;
            data.forEach(b => {
                tabel.innerHTML += `<tr><td class="p-6 font-bold">${b.client_name}<br><span class="text-xs text-emerald-600">${b.client_wa}</span></td><td class="p-6">${b.booking_date} | ${b.booking_time}</td><td class="p-6 text-right"><button onclick="hapus('${b.id}')" class="text-xs font-bold bg-slate-100 p-2 rounded-lg">SELESAI</button></td></tr>`;
            });
        }

        async function hapus(id) { if(confirm("Hapus?")) { await sb.from('bookings').delete().eq('id', id); ambilData(); } }
        function logout() { localStorage.removeItem('active_biz_id'); location.reload(); }
    </script>
</body>
</html>
