<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Oasis SaaS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="bg-white shadow-sm border-b p-4 mb-8 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <span class="bg-emerald-100 p-2 rounded-lg">ðŸŒ¿</span> 
                <span id="displayBizName">Memuat Dashboard...</span>
            </h1>
            <div class="flex items-center gap-3">
                <input type="text" id="searchInput" placeholder="Cari nama tamu..." 
                    class="border border-slate-200 p-2 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none hidden md:block">
                <button onclick="fetchBookings()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-emerald-700 transition shadow-lg shadow-emerald-100">
                    Refresh
                </button>
                <button onclick="logout()" class="text-slate-400 hover:text-rose-600 p-2 transition" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-slate-500 text-sm font-medium">Total Booking</p>
                <h3 id="statTotal" class="text-3xl font-bold text-slate-800">0</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-slate-500 text-sm font-medium">Hari Ini</p>
                <h3 id="statToday" class="text-3xl font-bold text-emerald-600">0</h3>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-200">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider">
                            <th class="p-4 font-semibold">Nama Pelanggan</th>
                            <th class="p-4 font-semibold">WhatsApp</th>
                            <th class="p-4 font-semibold">Jadwal Reservasi</th>
                            <th class="p-4 font-semibold text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="bookingTable" class="text-slate-700 divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
            <div id="loader" class="p-20 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-emerald-500 border-t-transparent mb-4"></div>
                <p class="text-slate-400 animate-pulse">Sinkronisasi data database...</p>
            </div>
            <div id="emptyMsg" class="hidden p-20 text-center text-slate-400">
                Belum ada reservasi masuk.
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = "https://oivvcaeqfyssnphvtojg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9pdnZjYWVxZnlzc25waHZ0b2pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NTk3NDAsImV4cCI6MjA4NzAzNTc0MH0.cG0WG5_TWu7ivdNVkz4BlGyugHwHIKRlQS50e9iXKwo";
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentBiz = null;

        // 1. LOGIKA LOGIN & SESSION
        async function checkLogin() {
            const savedBiz = localStorage.getItem('oasis_session');
            
            if (savedBiz) {
                currentBiz = JSON.parse(savedBiz);
                document.getElementById('displayBizName').innerText = currentBiz.business_name;
                fetchBookings();
            } else {
                await performLogin();
            }
        }

        async function performLogin() {
            const bizIdInput = prompt("Masukkan ID Bisnis:");
            const passInput = prompt("Masukkan Password:");

            if (!bizIdInput || !passInput) {
                window.location.href = "index.html";
                return;
            }

            const { data, error } = await client
                .from('businesses')
                .select('*')
                .eq('id', bizIdInput.trim().toLowerCase())
                .eq('admin_password', passInput.trim())
                .maybeSingle();

            if (data) {
                currentBiz = data;
                localStorage.setItem('oasis_session', JSON.stringify(data));
                document.getElementById('displayBizName').innerText = data.business_name;
                fetchBookings();
            } else {
                alert("Login Gagal! Akun tidak ditemukan.");
                window.location.reload();
            }
        }

        // 2. AMBIL DATA DARI DATABASE
        async function fetchBookings() {
            if (!currentBiz) return;
            
            const loader = document.getElementById('loader');
            const tableBody = document.getElementById('bookingTable');
            const emptyMsg = document.getElementById('emptyMsg');

            loader.classList.remove('hidden');
            tableBody.innerHTML = '';
            emptyMsg.classList.add('hidden');

            const { data, error } = await client
                .from('bookings')
                .select('*')
                .eq('business_id', currentBiz.id)
                .order('booking_date', { ascending: true });

            loader.classList.add('hidden');

            if (error || !data || data.length === 0) {
                emptyMsg.classList.remove('hidden');
                updateStats(0, 0);
                return;
            }

            renderTable(data);
            calculateStats(data);
        }

        function renderTable(data) {
            const tableBody = document.getElementById('bookingTable');
            tableBody.innerHTML = '';
            
            data.forEach(item => {
                const cleanWA = item.client_wa.replace(/\D/g,'');
                const row = `
                    <tr class="hover:bg-slate-50 transition" id="row-${item.id}">
                        <td class="p-4 font-semibold text-slate-800">${item.client_name}</td>
                        <td class="p-4 text-slate-600">${item.client_wa}</td>
                        <td class="p-4 text-sm">
                            <span class="block text-slate-800 font-medium">${item.booking_date}</span>
                            <span class="text-emerald-600 font-bold">${item.booking_time}</span>
                        </td>
                        <td class="p-4">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="finishBooking('${item.id}', '${item.client_name}', '${cleanWA}')" 
                                    class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-emerald-700 transition active:scale-95 shadow-md shadow-emerald-100">
                                    âœ… SELESAI
                                </button>
                                <button onclick="deleteOnly('${item.id}')" class="p-2 text-slate-300 hover:text-rose-600 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // 3. FITUR SELESAI + KIRIM WA
        async function finishBooking(id, name, wa) {
            if (!confirm(`Selesaikan reservasi ${name}? Pelanggan akan menerima ucapan terima kasih via WA.`)) return;

            const message = `ðŸŒ¸ *TERIMA KASIH* ðŸŒ¸\n\nHalo ${name}, terima kasih telah berkunjung ke *${currentBiz.business_name}*.\n\nSemoga hari Anda menyenangkan dan kami tunggu kunjungan berikutnya! âœ¨`;
            
            try {
                // Kirim pesan via Fonnte
                const formData = new URLSearchParams();
                formData.append('target', wa);
                formData.append('message', message);

                fetch('https://api.fonnte.com/send', {
                    method: 'POST',
                    headers: { 'Authorization': currentBiz.wa_token },
                    body: formData
                });

                // Hapus dari Supabase
                await client.from('bookings').delete().eq('id', id);
                document.getElementById(`row-${id}`).remove();
                
            } catch (err) {
                alert("Gagal memproses.");
            }
        }

        async function deleteOnly(id) {
            if (confirm("Hapus data tanpa kirim pesan?")) {
                await client.from('bookings').delete().eq('id', id);
                document.getElementById(`row-${id}`).remove();
            }
        }

        function calculateStats(data) {
            const today = new Date().toISOString().split('T')[0];
            const todayCount = data.filter(item => item.booking_date === today).length;
            updateStats(data.length, todayCount);
        }

        function updateStats(total, today) {
            document.getElementById('statTotal').innerText = total;
            document.getElementById('statToday').innerText = today;
        }

        function logout() {
            localStorage.removeItem('oasis_session');
            window.location.reload();
        }

        // Pencarian Real-time
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#bookingTable tr');
            rows.forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(val) ? '' : 'none';
            });
        });

        // Jalankan sistem
        checkLogin();
    </script>
</body>
</html>
